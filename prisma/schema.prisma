generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Notes:
// - IDs use cuid for simplicity and good DX with Prisma.
// - Amount fields are stored as integer KRW (won) to avoid float issues.

enum UserRole {
  ADVERTISER
  MEMBER
  ADMIN
}

enum MemberType {
  NORMAL
  TEAM_LEADER
  TEAM_PRO_LEADER
}

enum AdminType {
  SUPER
  MANAGER
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

enum TermsType {
  SERVICE
  PRIVACY
  REWARDER_GUIDE
}

enum ExperienceCampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  ENDED
}

enum TeamStatus {
  FORMING
  ACTIVE
  COMPLETED
  CANCELLED
}

enum TeamMembershipRole {
  LEADER
  MEMBER
}

enum TeamMembershipStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  ENDED
}

enum MissionType {
  TRAFFIC
  SAVE
  SHARE
}

enum MissionDayStatus {
  ACTIVE
  PAUSED
  ENDED
}

enum ParticipationStatus {
  IN_PROGRESS
  PENDING_REVIEW
  MANUAL_REVIEW
  APPROVED
  REJECTED
  EXPIRED
  CANCELED
}

enum VerificationDecision {
  APPROVE
  REJECT
  NEED_MANUAL
}

enum LedgerReason {
  MISSION_REWARD
  MISSION_APPROVED_CHARGE
  PAYOUT
  PAYOUT_REVERSAL
  TOPUP
  REFUND
  ADJUSTMENT
}

enum PayoutStatus {
  REQUESTED
  APPROVED
  REJECTED
  PAID
  CANCELED
}

enum PaymentStatus {
  CREATED
  PAID
  FAILED
  CANCELED
  REFUNDED
}

enum PolicyKey {
  PRICING
  REWARD
  FRAUD
  PAYOUT
  MISSION_LIMITS
}

model User {
  id        String     @id @default(cuid())
  role      UserRole
  status    UserStatus @default(ACTIVE)
  memberType MemberType?
  adminType  AdminType?

  email     String?    @unique
  name      String?
  phone     String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  advertiserProfile AdvertiserProfile?
  memberProfile      MemberProfile?
  credential         AuthCredential?
  sessions           Session[]
  terms              TermsAgreement[]

  auditLogs     AuditLog[]
  notifications Notification[]

  // 체험단 시스템 관계들
  assignedAdvertisers AdvertiserManager[] @relation("AssignedByUser") // SUPER admin이 배정한 관계들
  managedAdvertisers  AdvertiserManager[] @relation("ManagerUser")    // MANAGER가 관리하는 광고주들
  experienceCampaigns ExperienceCampaign[] // MANAGER가 생성한 체험단 공고들
  teamLeaderTeams     Team[]              // TEAM_LEADER가 이끄는 팀들
  teamMemberships     TeamMembership[]    // 팀 멤버십들 (팀장/팀원 모두)
  decidedMemberships  TeamMembership[]    @relation("DecidedByUser") // 승인/거절한 팀 멤버십들
  invitationCodes     InvitationCode[]    // 생성한 초대코드들
}

model AuthCredential {
  id           String   @id @default(cuid())
  userId       String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
}

model TermsAgreement {
  id          String    @id @default(cuid())
  userId      String
  type        TermsType
  version     String
  acceptedAt  DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type, version])
  @@index([userId, acceptedAt])
}

model AdvertiserProfile {
  id             String   @id @default(cuid())
  userId         String   @unique
  displayName    String?
  businessNumber String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Restrict)
  places   Place[]
  campaigns Campaign[]
  budgetLedgers BudgetLedger[]
  payments Payment[]
  advertiserManagers AdvertiserManager[]
  experienceCampaigns ExperienceCampaign[]
}

model MemberProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  level       Int      @default(1)
  trustScore  Int      @default(0)
  warningCount Int     @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user          User           @relation(fields: [userId], references: [id], onDelete: Restrict)
  participations Participation[]
  creditLedgers  CreditLedger[]
  payoutAccounts PayoutAccount[]
  payoutRequests PayoutRequest[]
  fraudSignals   FraudSignal[]
}

model Place {
  id              String   @id @default(cuid())
  advertiserId     String
  name            String
  externalProvider String? // e.g. NAVER_PLACE
  externalId       String? // provider-specific identifier
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  advertiser AdvertiserProfile @relation(fields: [advertiserId], references: [id], onDelete: Restrict)
  campaigns  Campaign[]
  experienceCampaigns ExperienceCampaign[]

  @@index([advertiserId])
  @@index([externalProvider, externalId])
}

model Campaign {
  id            String        @id @default(cuid())
  advertiserId  String
  placeId       String
  name          String
  missionType   MissionType
  dailyTarget   Int
  startDate     DateTime
  endDate       DateTime
  unitPriceKrw  Int
  rewardKrw     Int
  budgetTotalKrw Int
  status        CampaignStatus @default(DRAFT)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  advertiser AdvertiserProfile @relation(fields: [advertiserId], references: [id], onDelete: Restrict)
  place      Place            @relation(fields: [placeId], references: [id], onDelete: Restrict)
  missionDays MissionDay[]

  @@index([advertiserId, status])
  @@index([placeId])
  @@index([missionType])
}

model MissionDay {
  id             String        @id @default(cuid())
  campaignId     String
  date           DateTime      // normalized to date (00:00)
  quotaTotal     Int
  quotaRemaining Int
  status         MissionDayStatus @default(ACTIVE)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  campaign       Campaign      @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  participations Participation[]

  @@unique([campaignId, date])
  @@index([date, status])
  @@index([campaignId, status])
}

model Participation {
  id             String              @id @default(cuid())
  missionDayId   String
  rewarderId     String
  status         ParticipationStatus @default(IN_PROGRESS)
  startedAt      DateTime           @default(now())
  expiresAt      DateTime
  submittedAt    DateTime?
  decidedAt      DateTime?
  failureReason  String?
  idempotencyKey String?            @unique
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  missionDay MissionDay   @relation(fields: [missionDayId], references: [id], onDelete: Restrict)
  rewarder   MemberProfile @relation(fields: [rewarderId], references: [id], onDelete: Restrict)
  evidences  VerificationEvidence[]
  result     VerificationResult?

  @@index([rewarderId, status])
  @@index([missionDayId, status])
  @@index([expiresAt])
}

model VerificationEvidence {
  id              String   @id @default(cuid())
  participationId String
  type            String   // SCREENSHOT | LOG (keep flexible for MVP)
  // In MVP we store images as data URLs (base64). This can exceed typical varchar limits, so use TEXT.
  fileRef         String?  @db.Text
  metadataJson    Json?
  ocrText         String?
  createdAt       DateTime @default(now())

  participation Participation @relation(fields: [participationId], references: [id], onDelete: Cascade)

  @@index([participationId])
}

model VerificationResult {
  id              String             @id @default(cuid())
  participationId String             @unique
  autoDecision    VerificationDecision?
  manualDecision  VerificationDecision?
  signalsJson     Json?
  decidedByAdminId String?
  decidedAt       DateTime?
  createdAt       DateTime           @default(now())

  participation Participation @relation(fields: [participationId], references: [id], onDelete: Cascade)
}

model CreditLedger {
  id         String       @id @default(cuid())
  rewarderId String
  amountKrw  Int
  reason     LedgerReason
  refId      String?      // participationId or payoutId, etc.
  createdAt  DateTime     @default(now())

  rewarder MemberProfile @relation(fields: [rewarderId], references: [id], onDelete: Restrict)

  @@index([rewarderId, createdAt])
  @@unique([reason, refId])
}

model BudgetLedger {
  id          String       @id @default(cuid())
  advertiserId String
  amountKrw   Int
  reason      LedgerReason
  refId       String?
  createdAt   DateTime     @default(now())

  advertiser AdvertiserProfile @relation(fields: [advertiserId], references: [id], onDelete: Restrict)

  @@index([advertiserId, createdAt])
  @@unique([reason, refId])
}

model PayoutAccount {
  id         String   @id @default(cuid())
  rewarderId String
  bankName   String
  accountNumberMasked String
  accountHolderName   String?
  isPrimary  Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  rewarder MemberProfile @relation(fields: [rewarderId], references: [id], onDelete: Restrict)
  payoutRequests PayoutRequest[]

  @@index([rewarderId, isPrimary])
}

model PayoutRequest {
  id            String      @id @default(cuid())
  rewarderId    String
  payoutAccountId String
  amountKrw     Int
  status        PayoutStatus @default(REQUESTED)
  failureReason String?
  idempotencyKey String?     @unique
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  decidedAt     DateTime?

  rewarder MemberProfile @relation(fields: [rewarderId], references: [id], onDelete: Restrict)
  payoutAccount PayoutAccount @relation(fields: [payoutAccountId], references: [id], onDelete: Restrict)

  @@index([rewarderId, status, createdAt])
  @@index([status, createdAt])
}

model Payment {
  id            String        @id @default(cuid())
  advertiserId  String
  amountKrw     Int
  status        PaymentStatus @default(CREATED)
  provider      String?       // e.g. PORTONE / TOSS / STRIPE
  providerRef   String?       @unique
  idempotencyKey String?      @unique
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  advertiser AdvertiserProfile @relation(fields: [advertiserId], references: [id], onDelete: Restrict)

  @@index([advertiserId, status, createdAt])
}

model FraudSignal {
  id            String   @id @default(cuid())
  rewarderId    String
  participationId String?
  type          String   // DUP_IMAGE | FAST | LOG_MISMATCH | IP_REPEAT ...
  severity      Int      @default(1) // 1..5
  payloadJson   Json?
  createdAt     DateTime @default(now())

  rewarder MemberProfile @relation(fields: [rewarderId], references: [id], onDelete: Restrict)

  @@index([rewarderId, createdAt])
  @@index([type, createdAt])
}

model Blacklist {
  id        String   @id @default(cuid())
  type      String   // IP | DEVICE
  value     String
  reason    String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  @@unique([type, value])
}

model Policy {
  id        String   @id @default(cuid())
  key       PolicyKey
  version   Int      @default(1)
  payloadJson Json
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@index([key, isActive, createdAt])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  channel   String   // EMAIL | KAKAO | IN_APP
  type      String
  payloadJson Json?
  readAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([type, createdAt])
}

model VerificationCode {
  id        String   @id @default(cuid())
  phone     String   @unique
  code      String
  expiresAt DateTime
  attempts  Int      @default(0)
  createdAt DateTime @default(now())

  @@index([phone])
  @@index([expiresAt])
}

model AuditLog {
  id        String   @id @default(cuid())
  actorUserId String?
  action    String
  targetType String?
  targetId  String?
  payloadJson Json?
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())

  actorUser User? @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([actorUserId, createdAt])
  @@index([action, createdAt])
  @@index([targetType, targetId])
}

// 체험단 시스템 모델들

model AdvertiserManager {
  id           String   @id @default(cuid())
  advertiserId String
  managerId    String   // AdminType이 MANAGER인 사용자
  assignedBy   String   // AdminType이 SUPER인 사용자
  assignedAt   DateTime @default(now())
  isActive     Boolean  @default(true)

  advertiser AdvertiserProfile @relation(fields: [advertiserId], references: [id], onDelete: Restrict)
  manager    User            @relation("ManagerUser", fields: [managerId], references: [id], onDelete: Restrict)
  assignedByUser User       @relation("AssignedByUser", fields: [assignedBy], references: [id], onDelete: Restrict)

  @@unique([advertiserId, managerId])
  @@index([advertiserId])
  @@index([managerId])
}

model ExperienceCampaign {
  id            String                  @id @default(cuid())
  managerId     String                  // AdminType이 MANAGER인 사용자
  advertiserId  String                  // 배정된 광고주
  placeId       String                  // 광고주의 장소
  title         String
  description   String?                 @db.Text
  targetTeamCount Int                   @default(1) // 목표 팀 수
  maxMembersPerTeam Int                @default(5) // 팀당 최대 인원
  applicationDeadline DateTime          // 신청 마감일
  startDate     DateTime                // 체험 시작일
  endDate       DateTime                // 체험 종료일
  status        ExperienceCampaignStatus @default(DRAFT)
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt

  manager     User             @relation(fields: [managerId], references: [id], onDelete: Restrict)
  advertiser  AdvertiserProfile @relation(fields: [advertiserId], references: [id], onDelete: Restrict)
  place       Place            @relation(fields: [placeId], references: [id], onDelete: Restrict)
  teams       Team[]

  @@index([managerId, status])
  @@index([advertiserId])
  @@index([placeId])
  @@index([applicationDeadline])
}

model Team {
  id            String       @id @default(cuid())
  experienceCampaignId String
  leaderId      String       // TEAM_LEADER인 사용자
  name          String
  description   String?      @db.Text
  status        TeamStatus   @default(FORMING)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  experienceCampaign ExperienceCampaign @relation(fields: [experienceCampaignId], references: [id], onDelete: Restrict)
  leader            User              @relation(fields: [leaderId], references: [id], onDelete: Restrict)
  memberships       TeamMembership[]
  invitationCodes   InvitationCode[]

  @@index([experienceCampaignId])
  @@index([leaderId])
  @@index([status])
}

model TeamMembership {
  id            String                @id @default(cuid())
  teamId        String
  memberId      String                // MEMBER인 사용자
  role          TeamMembershipRole
  status        TeamMembershipStatus  @default(PENDING)
  appliedAt     DateTime              @default(now())
  decidedAt     DateTime?
  decidedBy     String?               // 승인/거절한 사용자 ID
  failureReason String?
  invitedByCode String?               // 초대코드로 참여한 경우
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt

  team     Team  @relation(fields: [teamId], references: [id], onDelete: Cascade)
  member   User  @relation(fields: [memberId], references: [id], onDelete: Restrict)
  decidedByUser User? @relation("DecidedByUser", fields: [decidedBy], references: [id], onDelete: SetNull)

  @@unique([teamId, memberId])
  @@index([teamId, status])
  @@index([memberId, status])
  @@index([decidedBy])
}

model InvitationCode {
  id            String   @id @default(cuid())
  teamId        String
  code          String   @unique
  createdBy     String   // TEAM_LEADER인 사용자
  expiresAt     DateTime
  maxUses       Int      @default(1)
  currentUses   Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())

  team       Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  createdByUser User @relation(fields: [createdBy], references: [id], onDelete: Restrict)

  @@index([teamId])
  @@index([code])
  @@index([expiresAt])
}


